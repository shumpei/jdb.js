"use strict",function(a){function c(a,b){if(!a)throw b;return!0}function d(a){return a.charAt(0).toUpperCase()+a.substring(1)}function e(a,b){for(var c in b)a[c]=b[c];return a}function f(b){if(a[b])return a[b];var b=d(b);return a["webkit"+b]||a["moz"+b]||a["o"+b]||a["ms"+b]}function g(a){return a===null||a===undefined}function r(a){this.store=a,this.filters=[]}function s(a){this.idbRequest=a}var b=Array.prototype.slice,h=a.indexedDB=f("indexedDB"),i=a.IDBDatabase=f("IDBDatabase"),j=a.IDBCursor=f("IDBCursor"),k=a.IDBKeyRange=f("IDBKeyRange"),l=a.IDBTransaction=f("IDBTransaction"),m=function(a){this.idbRequest=a};m.prototype={error:function(a){return this.idbRequest.addEventListener("error",a,!1),this},success:function(a){var b=this.idbRequest;return b.addEventListener("success",a,!1),this}};var n=function(a,b){this.name=a,this.version=b,this.stores={}};n.prototype={getStoreNames:function(){return Object.keys(this.stores)},transaction:function(a,b){b=b||{};var c=b.mode;return typeof c!="number"&&(c=l.READ_WRITE),p(a,this,c,b.stores,b.onAbort,b.onComplete,b.onError)},_upgrade:function(a,b,c){function g(a,b){var c=a-1,d=f[c];d===undefined&&(d=f[c]=[]),d.push(b)}var d=this,e=d.idbDatabase;console.log("oldVersion:"+b+" newVersion:"+c);var f=[],h=d.stores;for(var i in h){var j=h[i],k=j.since||1;if(typeof k=="number"&&b<k&&k<=c){var l=function(a,b){return function(c){console.log("create object store:"+a+", keyPath:"+b.keyPath+", autoIncrement:"+b.autoIncrement),c.createObjectStore(a,b)}},m=j.key,n={keyPath:m.path,autoIncrement:m.autoIncrement};g(k,l(i,n))}var o=j.indexes;for(var p in o){var q=o[p],k=q.since||1;if(typeof k=="number"&&b<k&&k<=c){var r=function(b,c,d,e){return function(f){var g=a.objectStore(b);console.log("create index:[storeName="+b+"][indexName="+c+"][keyPath="+d+"]"),g.createIndex(c,d,e)}},s={unique:!!q.unique,multientry:!!q.multientry};g(k,r(i,p,q.path,s))}}}for(var t=b,u=f.length;t<u;t++){var v=f[t];for(var w=0,x=v.length;w<x;w++)v[w](e)}},open:function(a,b){var c=this;console.log("name:"+this.name+",version:"+this.version);var d=h.open(this.name,this.version);return typeof a=="function"&&d.addEventListener("success",function(){var e=c.idbDatabase=d.result;if(typeof e.setVersion=="function"){var f=e.version?parseInt(e.version,10):0,g=c.version;if(f!==g){var h=e.setVersion(g);h.onsuccess=function(){console.log("using legacy API: IDBDatabase#setVersion()"),c._upgrade(this.transaction,f,g),a()},h.onerror=function(){b(h.error)}}else a()}else a()},!1),typeof b=="function"&&d.addEventListener("error",b,!1),d.onupgradeneeded=function(b){var e=c.idbDatabase=d.result,f=d.transaction,g=b.oldVersion||0,h=b.newVersion;c._upgrade(f,g,h),a()},new m(d)}};var o,p=function(a,b,c,d,e,f,g){o||(o=new q(b,c,d,e,f));try{return o.execute(a)}finally{o=null}},q=function(a,c,d,e,f,g){this.database=a,this.mode=c,this.active=!1,this.onAbort=e,this.onError=g,this.onComplete=f;var h=[];if(d===null||d===undefined)h=b.call(a.getStoreNames());else if(d instanceof Array)d.forEach(function(a){a instanceof v?h.push(a.name):typeof a=="string"&&h.push(a)});else if(d instanceof v)h.push(d.name);else{if(typeof d!="string")throw"could not process argument[stores]:"+d;h.push(d)}this.storeNames=h};q.prototype={begin:function(){var a=this.database.idbDatabase,b=this.idbTransaction=a.transaction(this.storeNames,this.mode);typeof this.onError=="function"&&b.addEventListener("error",this.onError,!1),typeof this.onComplete=="function"&&b.addEventListener("complete",this.onComplete,!1),typeof this.onAbort=="function"&&b.addEventListener("abort",this.onAbort,!1),this.active=!0},abort:function(){if(!this.active)throw"Transaction is not active";this.idbTransaction.abort()},execute:function(a){this.begin();try{return a(this)}catch(b){throw this.abort(),b}}},r.prototype={criteria:function(a){return this._criteria=a,this},filter:function(a){return this.filters.push(a),this},_getData:function(a,b,c){var d=this,e=d.filters,f=d._criteria;return p(function(g){var h=g.idbTransaction.objectStore(d.store.name),i;f?i=f.createCursor(h):i=h.openCursor(),i.onsuccess=function(){var b=i.result;if(!b){typeof c=="function"&&c();return}var d=b.value;for(var f=0,g=e.length;f<g;f++)if(!e[f](d)){b["continue"]();return}var h=a(d);h!==!1&&b["continue"]()},i.onerror=function(){b(undefined,i.error)}},d.store.database,l.READ_ONLY,d.store)},iterate:function(a){return this._getData(a,a)},list:function(a){var b=[];return this._getData(function(c){b.push(c)},function(c){a(undefined,c)},function(){a(b)})}},s.prototype={error:function(a){return this.idbRequest.addEventListener("error",a,!1),this},success:function(a){var b=this.idbRequest;return b.addEventListener("success",function(){a(b.result)},!1),this}};var t=function(){this._direction="next",this._dup=!0};t.prototype={only:function(a){this._only=a},upper:function(a,b){return this._upper=a,this._upperOpen=!!b,this},lower:function(a,b){return this._lower=a,this._lowerOpen=!!b,this},dir:function(a){if(a!=="next"&&a!=="prev")throw'Invalid direction (must be "next" or "prev"):'+a;return this._direction=a,this},dup:function(a){this._dup=a!==!1},createCursor:function(a){var b,c;if(this._only)b=k.only(this._only);else{var d=this._upper,e=this._upperOpen,f=this._lower,h=this._lowerOpen;g(d)?g(f)||(b=k.lowerBound(f,h)):g(f)?b=k.upperBound(d,e):b=k.bound(f,d,h,e)}return this._direction==="next"?this._dup?c=k.NEXT:c=k.NEXT_NO_DUPLICATE:this._dup?c=k.PREV:c=k.PREV_NO_DUPLICATE,this._byKey?a.openCursor(b,c):a.index(this._indexName).openCursor(b,c)}};var u={byKey:function(){var a=new t;return a._byKey=!0,a},byIndex:function(a){var b=new t;return b._indexName=a,b}},v=function(a){c(a.name,'param "name" is required'),c(a.database instanceof n,'param "database" must be instance of JDBDatabase'),c(a.key,'param "key" is required'),this.name=a.name,this.database=a.database,this.key=a.key,this.indexes=a.indexes,this.since=a.since,this.database.stores[this.name]=this};v.prototype={remove:function(a,b){return this._exec(function(b,c){return c["delete"](a)},b,l.READ_WRITE)},clear:function(a){return this._exec(function(a,b){return b.clear()},a,l.READ_WRITE)},put:function(a,b){return this._exec(function(b,c){return c.put(a)},b,l.READ_WRITE)},get:function(a,b){return this._exec(function(b,c){return c.get(a)},b,l.READ_ONLY)},_exec:function(a,b,c){var d=this;return p(function(c){var e=c.idbTransaction.objectStore(d.name),f=a(c,e);return typeof b=="function"&&(f.addEventListener("success",function(){b(f.result)},!1),f.addEventListener("error",function(){b(undefined,f.error)},!1)),new s(f)},d.database,c,d)},all:function(){return new r(this)},criteria:function(a){var b=new r(this);return(new r(this)).criteria(a)},filter:function(a){return(new r(this)).filter(a)}},a.JDBDatabase=n,a.JDBObjectStore=v,a.JDBCriteria=u}(this);