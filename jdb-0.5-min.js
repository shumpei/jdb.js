"use strict",function(a){function c(a,b){if(!a)throw b;return!0}function d(a){return a.charAt(0).toUpperCase()+a.substring(1)}function e(a,b){for(var c in b)a[c]=b[c];return a}function f(b){if(a[b])return a[b];var b=d(b);return a["webkit"+b]||a["moz"+b]||a["o"+b]||a["ms"+b]}function q(a){this.store=a,this.filters=[]}function r(a){this.idbRequest=a}var b=Array.prototype.slice,g=a.indexedDB=f("indexedDB"),h=a.IDBDatabase=f("IDBDatabase"),i=a.IDBCursor=f("IDBCursor"),j=a.IDBKeyRange=f("IDBKeyRange"),k=a.IDBTransaction=f("IDBTransaction"),l=function(a){this.idbRequest=a};l.prototype={error:function(a){return this.idbRequest.addEventListener("error",a,!1),this},success:function(a){var b=this.idbRequest;return b.addEventListener("success",a,!1),this}};var m=function(a,b){this.name=a,this.version=b,this.stores={}};m.prototype={getStoreNames:function(){return Object.keys(this.stores)},transaction:function(a,b){b=b||{};var c=b.mode;return typeof c!="number"&&(c=k.READ_WRITE),o(a,this,c,b.stores,b.onAbort,b.onComplete,b.onError)},open:function(a,b){var c=this;console.log("name:"+this.name+",version:"+this.version);var d=g.open(this.name,this.version);return typeof a=="function"&&d.addEventListener("success",function(){c.idbDatabase=d.result,a()},!1),typeof b=="function"&&d.addEventListener("error",b,!1),d.onupgradeneeded=function(a){function i(a,b){var c=a-1,d=h[c];d===undefined&&(d=h[c]=[]),d.push(b)}var b=c.idbDatabase=d.result,e=d.transaction,f=a.oldVersion||0,g=a.newVersion;console.log("oldVersion:"+f+" newVersion:"+g);var h=[],j=c.stores;for(var k in j){var l=j[k],m=l.since||1;if(typeof m=="number"&&f<m&&m<=g){var n=function(a,b){return function(c){console.log("create object store:"+a+", keyPath:"+b.keyPath+", autoIncrement:"+b.autoIncrement),c.createObjectStore(a,b)}},o=l.key,p={keyPath:o.path,autoIncrement:o.autoIncrement};i(m,n(k,p))}var q=l.indexes;for(var r in q){var s=q[r],m=s.since||1;if(typeof m=="number"&&f<m&&m<=g){var t=function(a,b,c,d){return function(f){var g=e.objectStore(a);console.log("create index:[storeName="+a+"][indexName="+b+"][keyPath="+c+"]"),g.createIndex(b,c,d)}},u={unique:s.unique,multientry:s.multientry};i(m,t(k,r,s.path,u))}}}var b=d.result;for(var v=f,w=h.length;v<w;v++){var x=h[v];for(var y=0,z=x.length;y<z;y++)x[y](b)}},new l(d)}};var n,o=function(a,b,c,d,e,f,g){n||(n=new p(b,c,d,e,f));try{return n.execute(a)}finally{n=null}},p=function(a,c,d,e,f,g){this.database=a,this.mode=c,this.active=!1,this.onAbort=e,this.onError=g,this.onComplete=f;var h=[];if(d===null||d===undefined)h=b.call(a.storeNames);else if(d instanceof Array)d.forEach(function(a){a instanceof s?h.push(a.name):typeof a=="string"&&h.push(a)});else if(d instanceof s)h.push(d.name);else{if(typeof d!="string")throw"could not process argument[stores]:"+d;h.push(d)}this.storeNames=h};p.prototype={begin:function(){var a=this.database.idbDatabase,b=this.idbTransaction=a.transaction(this.storeNames,this.mode);typeof this.onError=="function"&&b.addEventListener("error",this.onError,!1),typeof this.onComplete=="function"&&b.addEventListener("complete",this.onComplete,!1),typeof this.onAbort=="function"&&b.addEventListener("abort",this.onAbort,!1),this.active=!0},abort:function(){if(!this.active)throw"Transaction is not active";this.idbTransaction.abort()},execute:function(a){this.begin();try{return a(this)}catch(b){throw this.abort(),b}}},q.prototype={range:function(){var a,b,c;return typeof arguments[0]=="string"?(a=arguments[0],b=arguments[1],c=arguments[2]):(b=arguments[0],c=arguments[1]),this.keyRange={path:a,range:b,direction:c},this},filter:function(a){return this.filters.push(a),this},iterate:function(a){var b=this,c=b.keyRange||{},d=b.filters;return o(function(e){var f=e.idbTransaction.objectStore(b.store.name),g=f.openCursor(c.range,c.direction);g.onsuccess=function(){var b=g.result;if(!b)return;var c=b.value;for(var e=0,f=d.length;e<f;e++)if(!d[e](c)){b["continue"]();return}var h=a(c);h!==!1&&b["continue"]()},g.onerror=function(){a(undefined,g.error)}},b.store.database,k.READ_ONLY,b.store)},list:function(a){var b=this,c=[],d=b.keyRange||{},e=b.filters;return o(function(f){var g=f.idbTransaction.objectStore(b.store.name),h=g.openCursor(d.range,d.direction);h.onsuccess=function(){var b=h.result;if(!b){a(c);return}var d=b.value;for(var f=0,g=e.length;f<g;f++)if(!e[f](d)){b["continue"]();return}c.push(d),ret!==!1&&b["continue"]()},h.onerror=function(){a(undefined,h.error)}},b.store.database,k.READ_ONLY,b.store)}},r.prototype={error:function(a){return this.idbRequest.addEventListener("error",a,!1),this},success:function(a){var b=this.idbRequest;return b.addEventListener("success",function(){a(b.result)},!1),this}};var s=function(a){c(a.name,'param "name" is required'),c(a.database instanceof m,'param "database" must be instance of JDBDatabase'),c(a.key,'param "key" is required'),this.name=a.name,this.database=a.database,this.key=a.key,this.indexes=a.indexes,this.since=a.since,this.database.stores[this.name]=this};s.prototype={put:function(a,b){var c=this;return o(function(d){var e=d.idbTransaction.objectStore(c.name),f=e.put(a);return typeof b=="function"&&(f.addEventListener("success",function(){b(f.result)},!1),f.addEventListener("error",function(){b(undefined,f.error)},!1)),new r(f)},this.database,k.READ_WRITE,this)},get:function(a,b){var c=this;return o(function(d){var e=d.idbTransaction.objectStore(c.name),f=e.get(a);return typeof b=="function"&&(f.addEventListener("success",function(){b(f.result)},!1),f.addEventListener("error",function(){b(undefined,f.error)},!1)),new r(f)},this.database,k.READ_ONLY,this)},all:function(){return new q(this)},range:function(){var a=new q(this);return q.prototype.range.apply(a,b.call(arguments))},filter:function(a){return(new q(this)).filter(a)}},a.JDBDatabase=m,a.JDBObjectStore=s}(this);